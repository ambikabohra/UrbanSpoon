<!DOCTYPE html>
<html>
    <head>
        <title>Restaurants</title>
        <meta charset="utf-8"/>
        <link rel="stylesheet" type="text/css" href="/static/restaurants.css"> 
        <link rel="stylesheet" type="text/css" href="/static/home.css"> 
        
    </head>
    <body onload="onLoadHandler()">
        <ul class="topnav">
            <li class="right"><a onclick='goHome()'>Logout</a></li>
        </ul>
        <div class="container">
            <form class="search-container"  onsubmit="event.preventDefault(); onLoadHandler();">
                <input type="text" name="search" id="location" placeholder="Search by location">
                <div onclick="onLoadHandler()">
                    <button type="submit">Go</button>
                </div>
            </form>
           
            <div id="map" style="width:100%;height:600px"></div>
            <div id="restaurant-list"></div>
        </div>
    <!-- </body> -->
    <script>
        var map;
        function initMap() {
            
          map = new google.maps.Map(document.getElementById('map'), {
            zoom: 11,
            center: new google.maps.LatLng(37.335480,-121.893028),
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            scrollwheel: false
          });
          
       
          // Create a <script> tag and set the USGS URL as the source.
          var script = document.createElement('script');
     
          script.src = onLoadHandler();
          document.getElementsByTagName('head')[0].appendChild(script);
        }

        // Adds a marker to the map and push to the array.
        var markers = [];
       
        function addMarker(location, restaurantName){
            var rs = location.split(",");
            console.log(parseFloat(rs[0]));
            var myLatLng = {lat: parseFloat(rs[0]), lng: parseFloat(rs[1])};
            
            var marker = new google.maps.Marker({
            position: myLatLng,
            // animation:google.maps.Animation.BOUNCE,
            map: map
            });
            markers.push(marker);

              //restaurants name on pop-up info window
            var infowindow = new google.maps.InfoWindow({
                content: restaurantName
           
            });
            infowindow.open(map,marker);
        }

      
       

      // Sets the map on all markers in the array.
      function setMapOnAll(map) {
        for (var i = 0; i < markers.length; i++) {
          markers[i].setMap(map);
        }
      }

      // Removes the markers from the map, but keeps them in the array.
      function clearMarkers() {
        setMapOnAll(null);
      }

      // Shows any markers currently in the array.
      function showMarkers() {
        setMapOnAll(map);
      }

      // Deletes all markers in the array by removing references to them.
      function deleteMarkers() {
        clearMarkers();
        markers = [];
      }

    
        // Loop through the results array and place a marker for each
        // set of coordinates.
        window.eqfeed_callback = function(results) {
          for (var i = 0; i < results.features.length; i++) {
            var coords = results.features[i].geometry.coordinates;
            var latLng = new google.maps.LatLng(coords[1],coords[0]);
            var marker = new google.maps.Marker({
              position: latLng,
              map: map
            });
          }
        }
    
        function onLoadHandler() {
                clearMarkers()
                const list = document.getElementById("restaurant-list");
                const location = document.getElementById("location").value;
                console.log(location);
                const data = {
                    location: location
                };
    
                fetch("/search-restaurants", {
                    method : "POST",
                    body: JSON.stringify(data),
                    headers:{
                        'Content-Type': 'application/json'
                    }
                })
                .then(r => r.json())
                .then(response => {
                    if (Array.isArray(response.restaurants)) {
                        console.log('Success:', JSON.stringify(response));
    
                        // const list = document.getElementById("restaurant-list");
                        appendRestaurants(list, response.restaurants);
                    }
                    else if(response.message === "Please enter valid location!"){
                            while (list.firstChild) {
                            list.removeChild(list.firstChild);
                        }
                    }
                }).catch(error => {
                    console.error('Error:', error)
                });
            }
    
    
        function appendRestaurants(node, array) {
                while (node.firstChild) {
                    node.removeChild(node.firstChild);
                }
                let nodeTemplate = "";
                array.forEach(item => {
                    addMarker(item.location, item.name)
                    nodeTemplate = nodeTemplate + `<div class="restaurant">
                        <div class="img-container">
                            <img src=${item.image}></img>
                        </div>

                        <div class="data-container">
                            <div>${item.name}</div>
                            <div>${item.address}</div>
                            <div>${item.rating}</div>
                            <div>${item.cuisine}</div>
                        </div>
                    </div>`;
                });
                node.insertAdjacentHTML('beforeend', nodeTemplate);
            }
            function goHome() {

            fetch("/logout", {
                method : "POST",
                headers:{
                    'Content-Type': 'application/json'
                }
            })
            .then(r => r.json())
            .then(response => {
                if (response.message === "Success") {
                    window.location = "/";

                }
                else {
                    window.alert("Unable to Logout!");
                }
                console.log('Success:', JSON.stringify(response));
            }).catch(error => {
                console.error('Error:', error)
            });
        }
    
      </script>
      <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAX4MnOHKKbsRC7rW1s7G5av1Vxt90hgL0&callback=initMap">
      </script>
    </body>
    </html>

<!-- 
function initialize() {
    geocoder = new google.maps.Geocoder();
    var mapCanvas = document.getElementById('map_canvas');
    var mapOptions = {
      center: new google.maps.LatLng(64.113598, -21.8569031),
      zoom: 12,
      scrollwheel: false,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    }
    var map = new google.maps.Map(mapCanvas, mapOptions)

    function getAddress (address) {
      geocoder.geocode( { 'address': address}, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
          map.setCenter(results[0].geometry.location);
          var marker = new google.maps.Marker({
            map: map,
            position: results[0].geometry.location
          });
        } else {
          return;
        }
      });
    }

    getAddress("some address here");

  }
  google.maps.event.addListener(marker, 'click', function() {
    map.setZoom(8);
  });
  google.maps.event.addDomListener(window, 'load', initialize); -->